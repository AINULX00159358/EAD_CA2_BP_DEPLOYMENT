# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool:
  vmImage: ubuntu-latest


steps:

  - task: KubectlInstaller@0
    inputs:
      kubectlVersion: '1.25.4'

  - task: HelmInstaller@0
    inputs:
      helmVersion: '2.14.1'
      installKubectl: true
  
  - task: AzureCLI@2
    inputs:
      azureSubscription: 'Azure for Students(7263e463-da66-4888-a897-f34f5acea14b)'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: 'az acr login --name ainhabAKS.azurecr.io'

  - task: HelmDeploy@0
    inputs:
      connectionType: 'Kubernetes Service Connection'
      kubernetesServiceConnection: 'ingress-basic'
      namespace: 'ingress-basic'
      command: 'upgrade'
      chartType: 'Name'
      chartName: 'ingress-nginx/ingress-nginx'
      releaseName: 'ingress-nginx'
      arguments: "--install"
      overrideValues: 'controller.service.annotations."service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path"=/healthz'