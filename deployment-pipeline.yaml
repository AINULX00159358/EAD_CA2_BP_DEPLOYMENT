# test deploy in kubernates

trigger:
  - None

pool:
  vmImage: ubuntu-latest

steps:
  - task: HelmInstaller@0
    displayName: 'installHelm'
    inputs:
      helmVersion: 3.9.3
      kubectlVersion: 1.26.3
  - task: AzureCLI@2
    displayName: 'Login to Azure Container Registry'
    inputs:
      azureSubscription: 'Azure for Students(7263e463-da66-4888-a897-f34f5acea14b)'
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az acr login --name ainhabacr.azurecr.io
  - task: HelmDeploy@0
    displayName: 'helm upgrade or install ap'
    inputs:
      connectionType: Kubernetes Service Connection
      kubernetesServiceEndpoint: 'ainhab-blue'
      namespace: 'blue'
      command: 'upgrade'
      chartType: Name
      chartName: 'oci://ainhabacr.azurecr.io/charts/bpwebapp'
      releaseName: 'bpwebapp'
      waitForExecution: false
      force: true
      upgradetiller: false
      save: false
      install: false
      arguments: '--install'
  # - task: Kubernetes@1
  #   inputs:
  #     connectionType: 'Kubernetes Service Connection'
  #     kubernetesServiceEndpoint: 'default-svc-conn'
  #     namespace: 'default'
  #     command: 'apply'
  #     useConfigurationFile: true
  #     configuration: '$(Build.SourcesDirectory)/LoadBalancer/bp-webapp-main-service.yaml'
  #     secretType: 'dockerRegistry'
  #     containerRegistryType: 'Azure Container Registry'